---
import type { SEOProps } from '@jet-w/astro-blog/types';
import { siteConfig, defaultSEO } from '@jet-w/astro-blog/config';
import '@jet-w/astro-blog/styles/global.css';
import fs from 'node:fs';
import path from 'node:path';

export interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
}

const {
  title = defaultSEO.title,
  description = defaultSEO.description,
  image = defaultSEO.image,
  type = 'website',
  publishedTime,
  modifiedTime,
  tags
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const fullTitle = title === siteConfig.title ? title : `${title} | ${siteConfig.title}`;
const fullImage = new URL(image, Astro.site);

// 检查 favicon 文件是否存在，不存在则使用 avatar
const publicDir = path.join(process.cwd(), 'public');
const faviconSvgExists = fs.existsSync(path.join(publicDir, 'favicon.svg'));
const faviconIcoExists = fs.existsSync(path.join(publicDir, 'favicon.ico'));
const faviconHref = faviconSvgExists ? '/favicon.svg' : faviconIcoExists ? '/favicon.ico' : siteConfig.avatar;
const faviconType = faviconSvgExists ? 'image/svg+xml' : faviconIcoExists ? 'image/x-icon' : 'image/jpeg';
---

<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type={faviconType} href={faviconHref} />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO -->
    <title>{fullTitle}</title>
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph -->
    <meta property="og:type" content={type} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={fullImage} />
    <meta property="og:site_name" content={siteConfig.title} />

    {publishedTime && (
      <meta property="article:published_time" content={publishedTime} />
    )}
    {modifiedTime && (
      <meta property="article:modified_time" content={modifiedTime} />
    )}
    {tags && tags.map(tag => (
      <meta property="article:tag" content={tag} />
    ))}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={fullImage} />

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title={siteConfig.title} href="/rss.xml" />

    <!-- 预加载关键资源 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- 图标库 -->
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" />
    <!-- Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round" />
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <!-- Remix Icon -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" />
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous" />
    <!-- Ionicons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>

    <!-- 主题检测脚本 -->
    <script is:inline>
      // 在页面加载前检测主题，避免闪烁
      // 默认使用深色模式
      const theme = (() => {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        // 默认深色模式，除非用户系统偏好浅色
        if (window.matchMedia('(prefers-color-scheme: light)').matches) {
          return 'light';
        }
        return 'dark';
      })();

      if (theme === 'light') {
        document.documentElement.classList.remove('dark');
      } else {
        document.documentElement.classList.add('dark');
      }
      window.__theme = theme;
    </script>
  </head>
  <body class="min-h-screen w-full overflow-x-hidden">
    <div id="app" class="flex flex-col min-h-screen w-full min-w-0">
      <slot />
    </div>

    <!-- Mermaid 容器渲染 -->
    <script src="/js/mermaid-container.js" is:inline></script>

    <!-- Tabs 组件初始化 -->
    <script src="/js/tabs-init.js" is:inline></script>

    <!-- 全局脚本 -->
    <script>
      // 回到顶部功能
      const backToTop = document.querySelector('.back-to-top');
      if (backToTop) {
        window.addEventListener('scroll', () => {
          if (window.scrollY > 300) {
            backToTop.classList.add('show');
          } else {
            backToTop.classList.remove('show');
          }
        });

        backToTop.addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }

      // 平滑滚动锚点链接
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (this: HTMLAnchorElement, e: Event) {
          e.preventDefault();
          const href = this.getAttribute('href');
          if (href) {
            const target = document.querySelector(href);
            if (target) {
              target.scrollIntoView({ behavior: 'smooth' });
            }
          }
        });
      });

      // 代码块增强功能
      function enhanceCodeBlocks() {
        const codeBlocks = document.querySelectorAll('pre:not([data-enhanced])');
        const COLLAPSE_THRESHOLD = 15; // 超过15行才显示收缩功能

        codeBlocks.forEach((pre) => {
          // 标记为已处理
          pre.setAttribute('data-enhanced', 'true');

          // 获取语言信息
          const code = pre.querySelector('code');
          let lang = 'code';

          // 跳过 mermaid 代码块
          if (code?.classList.contains('language-mermaid') ||
              pre.classList.contains('mermaid') ||
              pre.closest('.mermaid-container')) {
            return;
          }

          if (code) {
            // 从 class 中获取语言
            const classList = code.className.split(' ');
            for (const cls of classList) {
              if (cls.startsWith('language-')) {
                lang = cls.replace('language-', '');
                break;
              }
            }
          }

          // 从 data-language 属性获取（shiki 用这个）
          const preEl = pre as HTMLPreElement;
          if (preEl.dataset.language) {
            lang = preEl.dataset.language;
          }

          // 计算代码行数
          const codeText = code ? code.textContent : pre.textContent;
          const lineCount = (codeText || '').split('\n').length;
          const shouldCollapse = lineCount > COLLAPSE_THRESHOLD;

          // 创建包装器
          const wrapper = document.createElement('div');
          wrapper.className = 'code-block-wrapper' + (shouldCollapse ? ' collapsed' : '');

          // 创建头部
          const header = document.createElement('div');
          header.className = 'code-block-header';
          header.innerHTML = `
            <span class="code-block-lang">${lang}</span>
            <div class="code-block-actions">
              ${shouldCollapse ? `
                <button class="code-block-btn collapse-btn" title="展开/收缩">
                  <svg class="collapse-icon transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                  <span class="collapse-text">展开</span>
                </button>
              ` : ''}
              <button class="code-block-btn copy-btn" title="复制代码">
                <svg class="copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <span class="copy-text">复制</span>
              </button>
            </div>
          `;

          // 创建内容区
          const content = document.createElement('div');
          content.className = 'code-block-content';

          // 插入DOM
          if (!pre.parentNode) return;
          pre.parentNode.insertBefore(wrapper, pre);
          wrapper.appendChild(header);
          wrapper.appendChild(content);
          content.appendChild(pre);

          // 如果需要收缩，添加展开按钮和底部收起按钮
          if (shouldCollapse) {
            // 展开按钮（收缩状态显示）
            const expandOverlay = document.createElement('div');
            expandOverlay.className = 'code-block-expand';
            expandOverlay.innerHTML = `
              <button class="expand-btn">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
                <span>展开代码 (${lineCount} 行)</span>
              </button>
            `;
            content.appendChild(expandOverlay);

            // 底部收起按钮（展开状态显示）
            const collapseOverlay = document.createElement('div');
            collapseOverlay.className = 'code-block-collapse';
            collapseOverlay.innerHTML = `
              <button class="collapse-bottom-btn">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                </svg>
                <span>收起代码</span>
              </button>
            `;
            content.appendChild(collapseOverlay);

            // 展开按钮点击事件
            const expandBtn = expandOverlay.querySelector('.expand-btn');
            if (expandBtn) {
              expandBtn.addEventListener('click', () => {
                wrapper.classList.remove('collapsed');
                const collapseText = header.querySelector('.collapse-text') as HTMLElement | null;
                if (collapseText) collapseText.textContent = '收缩';
              });
            }

            // 底部收起按钮点击事件
            const collapseBottomBtn = collapseOverlay.querySelector('.collapse-bottom-btn');
            if (collapseBottomBtn) {
              collapseBottomBtn.addEventListener('click', () => {
                wrapper.classList.add('collapsed');
                const collapseText = header.querySelector('.collapse-text') as HTMLElement | null;
                if (collapseText) collapseText.textContent = '展开';
                // 滚动到代码块顶部
                wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
              });
            }
          }

          // 复制按钮点击事件
          const copyBtn = header.querySelector('.copy-btn') as HTMLElement | null;
          if (copyBtn) {
            copyBtn.addEventListener('click', async () => {
              const textToCopy = code ? code.textContent : pre.textContent;
              try {
                await navigator.clipboard.writeText(textToCopy || '');
                copyBtn.classList.add('copied');
                const copyText = copyBtn.querySelector('.copy-text') as HTMLElement | null;
                const copyIcon = copyBtn.querySelector('.copy-icon') as HTMLElement | null;
                if (copyText) copyText.textContent = '已复制';
                if (copyIcon) copyIcon.innerHTML = `
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                `;

                setTimeout(() => {
                  copyBtn.classList.remove('copied');
                  if (copyText) copyText.textContent = '复制';
                  if (copyIcon) copyIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  `;
                }, 2000);
              } catch (err) {
                console.error('复制失败:', err);
              }
            });
          }

          // 收缩按钮点击事件
          const collapseBtn = header.querySelector('.collapse-btn') as HTMLElement | null;
          if (collapseBtn) {
            collapseBtn.addEventListener('click', () => {
              const isCollapsed = wrapper.classList.toggle('collapsed');
              const collapseText = collapseBtn.querySelector('.collapse-text') as HTMLElement | null;
              if (collapseText) collapseText.textContent = isCollapsed ? '展开' : '收缩';
            });
          }
        });
      }

      // 页面加载后执行
      enhanceCodeBlocks();

      // 监听DOM变化（处理动态加载的内容）
      const observer = new MutationObserver((mutations) => {
        let hasNewCodeBlocks = false;
        mutations.forEach((mutation) => {
          if (mutation.addedNodes.length) {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === 1) {
                const el = node as Element;
                if (el.tagName === 'PRE' || el.querySelector?.('pre:not([data-enhanced])')) {
                  hasNewCodeBlocks = true;
                }
              }
            });
          }
        });
        if (hasNewCodeBlocks) {
          enhanceCodeBlocks();
        }
      });

      observer.observe(document.body, { childList: true, subtree: true });
    </script>

  </body>
</html>