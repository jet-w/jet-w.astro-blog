---
import { getCollection } from 'astro:content';
import PageLayout from '@jet-w/astro-blog/layouts/PageLayout.astro';
import PostCard from '@jet-w/astro-blog/components/blog/PostCard.astro';
import Pagination from '@jet-w/astro-blog/components/ui/Pagination.astro';

export async function getStaticPaths() {
  const postsPerPage = 10;
  const allPosts = await getCollection('posts', ({ data }) => !data.draft);

  // ä»æ‰€æœ‰æ–‡ç« ä¸­æ”¶é›†åˆ†ç±»
  const categoryMap = new Map<string, { name: string; posts: typeof allPosts }>();

  allPosts.forEach(post => {
    (post.data.categories || []).forEach(category => {
      const slug = category.toLowerCase().replace(/\s+/g, '-');
      if (categoryMap.has(slug)) {
        categoryMap.get(slug)!.posts.push(post);
      } else {
        categoryMap.set(slug, { name: category, posts: [post] });
      }
    });
  });

  // ä¸ºæ¯ä¸ªåˆ†ç±»çš„æ¯ä¸€é¡µç”Ÿæˆè·¯å¾„
  const paths: Array<{
    params: { category: string; page: string };
    props: { categorySlug: string; categoryName: string; page: number; totalPages: number };
  }> = [];

  categoryMap.forEach(({ name, posts }, slug) => {
    // æŒ‰æ—¥æœŸæ’åº
    const sortedPosts = posts.sort((a, b) => {
      const dateA = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
      const dateB = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
      return dateB - dateA;
    });

    const totalPages = Math.ceil(sortedPosts.length / postsPerPage);

    // ä¸ºæ¯ä¸€é¡µç”Ÿæˆè·¯å¾„ï¼ˆä»ç¬¬2é¡µå¼€å§‹ï¼Œç¬¬1é¡µç”± [category].astro å¤„ç†ï¼‰
    for (let page = 2; page <= totalPages; page++) {
      paths.push({
        params: { category: slug, page: page.toString() },
        props: { categorySlug: slug, categoryName: name, page, totalPages }
      });
    }
  });

  return paths;
}

const { categorySlug, categoryName, page: currentPage, totalPages } = Astro.props;
const postsPerPage = 10;

// è·å–æ‰€æœ‰æ–‡ç« å¹¶ç­›é€‰åŒ…å«è¯¥åˆ†ç±»çš„æ–‡ç« 
const allPosts = await getCollection('posts', ({ data }) => !data.draft);

// ç­›é€‰åŒ…å«è¯¥åˆ†ç±»çš„æ–‡ç« 
const filteredPosts = allPosts
  .filter(post =>
    (post.data.categories || []).some(c => c.toLowerCase().replace(/\s+/g, '-') === categorySlug)
  )
  .sort((a, b) => {
    const dateA = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
    const dateB = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
    return dateB - dateA;
  });

// åˆ†é¡µé€»è¾‘
const totalPosts = filteredPosts.length;
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const posts = filteredPosts.slice(startIndex, endIndex);

// è·å–ç›¸å…³åˆ†ç±»ï¼ˆåŒä¸€ç¯‡æ–‡ç« ä¸­å‡ºç°çš„å…¶ä»–åˆ†ç±»ï¼‰
const relatedCategoryMap = new Map<string, { name: string; count: number }>();
filteredPosts.forEach(post => {
  (post.data.categories || []).forEach(cat => {
    const slug = cat.toLowerCase().replace(/\s+/g, '-');
    if (slug !== categorySlug) {
      if (relatedCategoryMap.has(slug)) {
        relatedCategoryMap.get(slug)!.count++;
      } else {
        relatedCategoryMap.set(slug, { name: cat, count: 1 });
      }
    }
  });
});

const relatedCategories = Array.from(relatedCategoryMap.entries())
  .sort((a, b) => b[1].count - a[1].count)
  .slice(0, 3)
  .map(([slug, { name, count }]) => ({ slug, name, count }));
---

<PageLayout
  title={`åˆ†ç±»: ${categoryName} - ç¬¬ ${currentPage} é¡µ`}
  description={`æµè§ˆæ‰€æœ‰ ${categoryName} ç›¸å…³çš„æ–‡ç«  - ç¬¬ ${currentPage} é¡µ`}
  showSidebar={true}
>
  <!-- é¢åŒ…å±‘å¯¼èˆª -->
  <nav class="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400 mb-8">
    <a href="/" class="hover:text-primary-500 transition-colors">é¦–é¡µ</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <a href="/categories" class="hover:text-primary-500 transition-colors">åˆ†ç±»</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <a href={`/categories/${categorySlug}`} class="hover:text-primary-500 transition-colors">{categoryName}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <span class="text-slate-900 dark:text-slate-100">ç¬¬ {currentPage} é¡µ</span>
  </nav>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <div class="text-center mb-12">
    <div class="inline-flex items-center justify-center w-20 h-20 bg-amber-100 dark:bg-amber-900/30 rounded-full mb-6">
      <svg class="w-10 h-10 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
      </svg>
    </div>

    <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-4">
      {categoryName}
    </h1>

    <p class="text-xl text-slate-600 dark:text-slate-400 mb-8 max-w-2xl mx-auto">
      æµè§ˆ {categoryName} åˆ†ç±»ä¸‹çš„æ‰€æœ‰æ–‡ç« 
    </p>

    <!-- åˆ†ç±»ç»Ÿè®¡ -->
    <div class="inline-flex items-center space-x-6 text-sm text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 px-6 py-3 rounded-lg">
      <span>{categoryName}</span>
      <span>â€¢</span>
      <span>{totalPosts} ç¯‡æ–‡ç« </span>
      <span>â€¢</span>
      <span>ç¬¬ {currentPage} / {totalPages} é¡µ</span>
    </div>
  </div>

  <!-- æ–‡ç« åˆ—è¡¨ -->
  {posts.length > 0 ? (
    <div class="space-y-8 mb-12">
      {posts.map((post) => (
        <PostCard
          post={{
            slug: post.id.toLowerCase(),
            title: post.data.title,
            description: post.data.description,
            pubDate: post.data.pubDate,
            tags: post.data.tags,
            categories: post.data.categories,
            author: post.data.author,
            image: post.data.image
          }}
          layout="horizontal"
        />
      ))}
    </div>
  ) : (
    <div class="text-center py-16">
      <div class="text-6xl mb-4">ğŸ“‚</div>
      <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-2">
        æš‚æ— ç›¸å…³æ–‡ç« 
      </h3>
      <p class="text-slate-600 dark:text-slate-400 mb-6">
        ç›®å‰è¿˜æ²¡æœ‰ {categoryName} åˆ†ç±»çš„æ–‡ç« ï¼Œè¯·æŸ¥çœ‹å…¶ä»–åˆ†ç±»ã€‚
      </p>
      <a href="/categories" class="btn-secondary">
        æµè§ˆæ‰€æœ‰åˆ†ç±»
      </a>
    </div>
  )}

  <!-- åˆ†é¡µå¯¼èˆª -->
  {totalPages > 1 && (
    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      baseUrl={`/categories/${categorySlug}`}
    />
  )}

  <!-- ç›¸å…³åˆ†ç±» -->
  {relatedCategories.length > 0 && (
    <section class="mt-16 pt-8 border-t border-slate-200 dark:border-slate-700">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-6">
        ç›¸å…³åˆ†ç±»
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        {relatedCategories.map((relatedCategory) => (
          <a
            href={`/categories/${relatedCategory.slug}`}
            class="group card hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300"
          >
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-semibold text-slate-900 dark:text-slate-100 group-hover:text-amber-500 transition-colors">
                  {relatedCategory.name}
                </h3>
                <p class="text-sm text-slate-600 dark:text-slate-400">
                  {relatedCategory.count} ç¯‡æ–‡ç« 
                </p>
              </div>
              <svg class="w-5 h-5 text-slate-400 group-hover:text-amber-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </a>
        ))}
      </div>
    </section>
  )}
</PageLayout>
