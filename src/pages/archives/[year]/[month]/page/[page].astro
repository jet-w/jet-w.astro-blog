---
import { getCollection } from 'astro:content';
import PageLayout from '@jet-w/astro-blog/layouts/PageLayout.astro';
import PostCard from '@jet-w/astro-blog/components/blog/PostCard.astro';
import Pagination from '@jet-w/astro-blog/components/ui/Pagination.astro';

export async function getStaticPaths() {
  const postsPerPage = 10;
  const allPosts = await getCollection('posts', ({ data }) => !data.draft);

  // æ”¶é›†æ‰€æœ‰å¹´æœˆç»„åˆåŠå…¶æ–‡ç« 
  const archiveMap = new Map<string, { year: number; month: number; posts: typeof allPosts }>();

  allPosts.forEach(post => {
    if (post.data.pubDate) {
      const date = new Date(post.data.pubDate);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const key = `${year}-${month}`;

      if (archiveMap.has(key)) {
        archiveMap.get(key)!.posts.push(post);
      } else {
        archiveMap.set(key, { year, month, posts: [post] });
      }
    }
  });

  // ä¸ºæ¯ä¸ªå¹´æœˆçš„æ¯ä¸€é¡µç”Ÿæˆè·¯å¾„
  const paths: Array<{
    params: { year: string; month: string; page: string };
    props: { year: number; month: number; page: number; totalPages: number };
  }> = [];

  archiveMap.forEach(({ year, month, posts }) => {
    // æŒ‰æ—¥æœŸæ’åº
    const sortedPosts = posts.sort((a, b) => {
      const dateA = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
      const dateB = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
      return dateB - dateA;
    });

    const totalPages = Math.ceil(sortedPosts.length / postsPerPage);

    // ä¸ºæ¯ä¸€é¡µç”Ÿæˆè·¯å¾„ï¼ˆä»ç¬¬2é¡µå¼€å§‹ï¼Œç¬¬1é¡µç”± [month].astro å¤„ç†ï¼‰
    for (let page = 2; page <= totalPages; page++) {
      paths.push({
        params: { year: String(year), month: String(month).padStart(2, '0'), page: page.toString() },
        props: { year, month, page, totalPages }
      });
    }
  });

  return paths;
}

const { year, month, page: currentPage, totalPages } = Astro.props;
const postsPerPage = 10;

// è·å–è¯¥æœˆçš„æ‰€æœ‰æ–‡ç« 
const allPosts = await getCollection('posts', ({ data }) => !data.draft);

const filteredPosts = allPosts
  .filter(post => {
    if (!post.data.pubDate) return false;
    const date = new Date(post.data.pubDate);
    return date.getFullYear() === year && date.getMonth() + 1 === month;
  })
  .sort((a, b) => {
    const dateA = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
    const dateB = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
    return dateB - dateA;
  });

// åˆ†é¡µé€»è¾‘
const totalPosts = filteredPosts.length;
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const posts = filteredPosts.slice(startIndex, endIndex);

// æœˆä»½åç§°
const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
const monthName = monthNames[month - 1];
---

<PageLayout
  title={`å½’æ¡£: ${year}å¹´${month}æœˆ - ç¬¬ ${currentPage} é¡µ`}
  description={`${year}å¹´${month}æœˆçš„æ‰€æœ‰æ–‡ç« å½’æ¡£ - ç¬¬ ${currentPage} é¡µ`}
  showSidebar={true}
>
  <!-- é¢åŒ…å±‘å¯¼èˆª -->
  <nav class="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400 mb-8">
    <a href="/" class="hover:text-primary-500 transition-colors">é¦–é¡µ</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <a href="/archives" class="hover:text-primary-500 transition-colors">å½’æ¡£</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <a href={`/archives/${year}/${String(month).padStart(2, '0')}`} class="hover:text-primary-500 transition-colors">{year}å¹´{month}æœˆ</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <span class="text-slate-900 dark:text-slate-100">ç¬¬ {currentPage} é¡µ</span>
  </nav>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <div class="text-center mb-12">
    <div class="inline-flex items-center justify-center w-16 h-16 bg-primary-100 dark:bg-primary-900/30 rounded-full mb-4">
      <svg class="w-8 h-8 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    </div>

    <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-4">
      {year}å¹´{monthName}
    </h1>

    <p class="text-xl text-slate-600 dark:text-slate-400 mb-8">
      å…± {totalPosts} ç¯‡æ–‡ç« 
    </p>

    <!-- å½’æ¡£ç»Ÿè®¡ -->
    <div class="inline-flex items-center space-x-6 text-sm text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 px-6 py-3 rounded-lg">
      <span>{year}å¹´{month}æœˆ</span>
      <span>â€¢</span>
      <span>{totalPosts} ç¯‡æ–‡ç« </span>
      <span>â€¢</span>
      <span>ç¬¬ {currentPage} / {totalPages} é¡µ</span>
    </div>
  </div>

  <!-- æ–‡ç« åˆ—è¡¨ -->
  {posts.length > 0 ? (
    <div class="space-y-8 mb-12">
      {posts.map((post) => (
        <PostCard
          post={{
            slug: post.id.toLowerCase(),
            title: post.data.title,
            description: post.data.description,
            pubDate: post.data.pubDate,
            tags: post.data.tags,
            categories: post.data.categories,
            author: post.data.author,
            image: post.data.image
          }}
          layout="horizontal"
        />
      ))}
    </div>
  ) : (
    <div class="text-center py-16">
      <div class="text-6xl mb-4">ğŸ“…</div>
      <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-2">
        æš‚æ— æ–‡ç« 
      </h3>
      <p class="text-slate-600 dark:text-slate-400 mb-6">
        {year}å¹´{month}æœˆæš‚æ— å‘å¸ƒçš„æ–‡ç« 
      </p>
      <a href="/archives" class="btn-secondary">
        æµè§ˆæ‰€æœ‰å½’æ¡£
      </a>
    </div>
  )}

  <!-- åˆ†é¡µå¯¼èˆª -->
  {totalPages > 1 && (
    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      baseUrl={`/archives/${year}/${String(month).padStart(2, '0')}`}
    />
  )}
</PageLayout>
