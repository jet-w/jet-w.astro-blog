---
import { getCollection } from 'astro:content';
import PageLayout from '@jet-w/astro-blog/layouts/PageLayout.astro';
import PostCard from '@jet-w/astro-blog/components/blog/PostCard.astro';
import Pagination from '@jet-w/astro-blog/components/ui/Pagination.astro';
import { i18nConfig as virtualI18nConfig } from 'virtual:astro-blog-i18n';
import { defaultI18nConfig } from '../../../../../config/i18n';
import { getLocaleFromPath, getLocaleConfig, getLocalePrefix, filterPostsByLocale, removeBase } from '../../../../../utils/i18n';

export async function getStaticPaths() {
  const postsPerPage = 10;
  const allPosts = await getCollection('posts', ({ data }) => !data.draft);

  // æ”¶é›†æ‰€æœ‰å¹´æœˆç»„åˆåŠå…¶æ–‡ç« 
  const archiveMap = new Map<string, { year: number; month: number; posts: typeof allPosts }>();

  allPosts.forEach(post => {
    if (post.data.pubDate) {
      const date = new Date(post.data.pubDate);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const key = `${year}-${month}`;

      if (archiveMap.has(key)) {
        archiveMap.get(key)!.posts.push(post);
      } else {
        archiveMap.set(key, { year, month, posts: [post] });
      }
    }
  });

  // ä¸ºæ¯ä¸ªå¹´æœˆçš„æ¯ä¸€é¡µç”Ÿæˆè·¯å¾„
  const paths: Array<{
    params: { year: string; month: string; page: string };
    props: { year: number; month: number; page: number; totalPages: number };
  }> = [];

  archiveMap.forEach(({ year, month, posts }) => {
    // æŒ‰æ—¥æœŸæ’åº
    const sortedPosts = posts.sort((a, b) => {
      const dateA = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
      const dateB = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
      return dateB - dateA;
    });

    const totalPages = Math.ceil(sortedPosts.length / postsPerPage);

    // ä¸ºæ¯ä¸€é¡µç”Ÿæˆè·¯å¾„ï¼ˆä»ç¬¬2é¡µå¼€å§‹ï¼Œç¬¬1é¡µç”± [month].astro å¤„ç†ï¼‰
    for (let page = 2; page <= totalPages; page++) {
      paths.push({
        params: { year: String(year), month: String(month).padStart(2, '0'), page: page.toString() },
        props: { year, month, page, totalPages }
      });
    }
  });

  return paths;
}

const { year, month, page: currentPage, totalPages } = Astro.props;
const postsPerPage = 10;

// Get i18n config
const i18nConfig = virtualI18nConfig || defaultI18nConfig;
const base = import.meta.env.BASE_URL;

// Remove base URL from current path for locale detection
const pathWithoutBase = removeBase(Astro.url.pathname, base);

const currentLocale = getLocaleFromPath(pathWithoutBase, i18nConfig);
const localeConfig = getLocaleConfig(currentLocale, i18nConfig);
const ui = localeConfig.ui;
const localePrefix = getLocalePrefix(currentLocale, i18nConfig, base);

// è·å–è¯¥æœˆçš„æ‰€æœ‰æ–‡ç« 
const allPostsCollection = await getCollection('posts', ({ data }) => !data.draft);

// Filter posts by current locale
const allPosts = filterPostsByLocale(allPostsCollection, currentLocale, i18nConfig);

const filteredPosts = allPosts
  .filter(post => {
    if (!post.data.pubDate) return false;
    const date = new Date(post.data.pubDate);
    return date.getFullYear() === year && date.getMonth() + 1 === month;
  })
  .sort((a, b) => {
    const dateA = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
    const dateB = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
    return dateB - dateA;
  });

// åˆ†é¡µé€»è¾‘
const totalPosts = filteredPosts.length;
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const posts = filteredPosts.slice(startIndex, endIndex);

// æœˆä»½åç§°
const monthNames = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
const monthNamesEn = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
const monthName = currentLocale.startsWith('en') ? monthNamesEn[month - 1] : monthNames[month - 1];
const archiveTitle = currentLocale.startsWith('en') ? `${monthName} ${year}` : `${year}å¹´${monthName}`;
---

<PageLayout
  title={`${ui.archives}: ${archiveTitle} - ${ui.page} ${currentPage}`}
  description={`${ui.archives} ${archiveTitle} - ${ui.page} ${currentPage}`}
  showSidebar={true}
  i18nConfig={i18nConfig}
>
  <!-- é¢åŒ…å±‘å¯¼èˆª -->
  <nav class="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400 mb-8">
    <a href={`${localePrefix}/`} class="hover:text-primary-500 transition-colors">{ui.home}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <a href={`${localePrefix}/archives`} class="hover:text-primary-500 transition-colors">{ui.archives}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <a href={`${localePrefix}/archives/${year}/${String(month).padStart(2, '0')}`} class="hover:text-primary-500 transition-colors">{archiveTitle}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <span class="text-slate-900 dark:text-slate-100">{ui.page} {currentPage}</span>
  </nav>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <div class="text-center mb-12">
    <div class="inline-flex items-center justify-center w-16 h-16 bg-primary-100 dark:bg-primary-900/30 rounded-full mb-4">
      <svg class="w-8 h-8 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    </div>

    <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-4">
      {archiveTitle}
    </h1>

    <p class="text-xl text-slate-600 dark:text-slate-400 mb-8">
      {totalPosts} {ui.posts}
    </p>

    <!-- å½’æ¡£ç»Ÿè®¡ -->
    <div class="inline-flex items-center space-x-6 text-sm text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 px-6 py-3 rounded-lg">
      <span>{archiveTitle}</span>
      <span>â€¢</span>
      <span>{totalPosts} {ui.posts}</span>
      <span>â€¢</span>
      <span>{ui.page} {currentPage} / {totalPages}</span>
    </div>
  </div>

  <!-- æ–‡ç« åˆ—è¡¨ -->
  {posts.length > 0 ? (
    <div class="space-y-8 mb-12">
      {posts.map((post) => (
        <PostCard
          post={{
            slug: post.id.toLowerCase(),
            title: post.data.title,
            description: post.data.description,
            pubDate: post.data.pubDate,
            tags: post.data.tags,
            categories: post.data.categories,
            author: post.data.author,
            image: post.data.image
          }}
          layout="horizontal"
          localePrefix={localePrefix}
          locale={localeConfig.locale.dateLocale}
          ui={ui}
        />
      ))}
    </div>
  ) : (
    <div class="text-center py-16">
      <div class="text-6xl mb-4">ğŸ“…</div>
      <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-2">
        {ui.noPostsFound}
      </h3>
      <p class="text-slate-600 dark:text-slate-400 mb-6">
        {ui.noPostsFound}
      </p>
      <a href={`${localePrefix}/archives`} class="btn-secondary">
        {ui.archives}
      </a>
    </div>
  )}

  <!-- åˆ†é¡µå¯¼èˆª -->
  {totalPages > 1 && (
    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      baseUrl={`${localePrefix}/archives/${year}/${String(month).padStart(2, '0')}`}
    />
  )}
</PageLayout>
