---
import { getCollection } from 'astro:content';
import PageLayout from '@jet-w/astro-blog/layouts/PageLayout.astro';
import PostCard from '@jet-w/astro-blog/components/blog/PostCard.astro';
import Pagination from '@jet-w/astro-blog/components/ui/Pagination.astro';
import { i18nConfig as virtualI18nConfig } from 'virtual:astro-blog-i18n';
import { defaultI18nConfig } from '../../../../config/i18n';
import { getLocaleFromPath, getLocaleConfig, getLocalePrefix, filterPostsByLocale, removeBase } from '../../../../utils/i18n';

export async function getStaticPaths() {
  const postsPerPage = 10;
  const allPosts = await getCollection('posts', ({ data }) => !data.draft);

  // ä»æ‰€æœ‰æ–‡ç« ä¸­æ”¶é›†æ ‡ç­¾
  const tagMap = new Map<string, { name: string; posts: typeof allPosts }>();

  allPosts.forEach(post => {
    (post.data.tags || []).forEach(tag => {
      const slug = tag.toLowerCase().replace(/\s+/g, '-');
      if (tagMap.has(slug)) {
        tagMap.get(slug)!.posts.push(post);
      } else {
        tagMap.set(slug, { name: tag, posts: [post] });
      }
    });
  });

  // ä¸ºæ¯ä¸ªæ ‡ç­¾çš„æ¯ä¸€é¡µç”Ÿæˆè·¯å¾„
  const paths: Array<{
    params: { tag: string; page: string };
    props: { tagSlug: string; tagName: string; page: number; totalPages: number };
  }> = [];

  tagMap.forEach(({ name, posts }, slug) => {
    // æŒ‰æ—¥æœŸæ’åº
    const sortedPosts = posts.sort((a, b) => {
      const dateA = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
      const dateB = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
      return dateB - dateA;
    });

    const totalPages = Math.ceil(sortedPosts.length / postsPerPage);

    // ä¸ºæ¯ä¸€é¡µç”Ÿæˆè·¯å¾„ï¼ˆä»ç¬¬2é¡µå¼€å§‹ï¼Œç¬¬1é¡µç”± [tag].astro å¤„ç†ï¼‰
    for (let page = 2; page <= totalPages; page++) {
      paths.push({
        params: { tag: slug, page: page.toString() },
        props: { tagSlug: slug, tagName: name, page, totalPages }
      });
    }
  });

  return paths;
}

const { tagSlug, tagName, page: currentPage, totalPages } = Astro.props;
const postsPerPage = 10;

// Get i18n config
const i18nConfig = virtualI18nConfig || defaultI18nConfig;
const base = import.meta.env.BASE_URL;

// Remove base URL from current path for locale detection
const pathWithoutBase = removeBase(Astro.url.pathname, base);

const currentLocale = getLocaleFromPath(pathWithoutBase, i18nConfig);
const localeConfig = getLocaleConfig(currentLocale, i18nConfig);
const ui = localeConfig.ui;
const localePrefix = getLocalePrefix(currentLocale, i18nConfig, base);

// è·å–æ‰€æœ‰æ–‡ç« å¹¶ç­›é€‰åŒ…å«è¯¥æ ‡ç­¾çš„æ–‡ç« 
const allPostsCollection = await getCollection('posts', ({ data }) => !data.draft);

// Filter posts by current locale
const allPosts = filterPostsByLocale(allPostsCollection, currentLocale, i18nConfig);

// ç­›é€‰åŒ…å«è¯¥æ ‡ç­¾çš„æ–‡ç« 
const filteredPosts = allPosts
  .filter(post =>
    (post.data.tags || []).some(t => t.toLowerCase().replace(/\s+/g, '-') === tagSlug)
  )
  .sort((a, b) => {
    const dateA = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
    const dateB = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
    return dateB - dateA;
  });

// åˆ†é¡µé€»è¾‘
const totalPosts = filteredPosts.length;
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const posts = filteredPosts.slice(startIndex, endIndex);

// è·å–ç›¸å…³æ ‡ç­¾ï¼ˆä»å½“å‰æ ‡ç­¾æ–‡ç« ä¸­æå–å…¶ä»–æ ‡ç­¾ï¼‰
const relatedTagMap = new Map<string, { name: string; count: number }>();
filteredPosts.forEach(post => {
  (post.data.tags || []).forEach(t => {
    const slug = t.toLowerCase().replace(/\s+/g, '-');
    if (slug !== tagSlug) {
      if (relatedTagMap.has(slug)) {
        relatedTagMap.get(slug)!.count++;
      } else {
        relatedTagMap.set(slug, { name: t, count: 1 });
      }
    }
  });
});

const relatedTags = Array.from(relatedTagMap.entries())
  .map(([slug, { name, count }]) => ({ slug, name, count }))
  .sort((a, b) => b.count - a.count)
  .slice(0, 8);
---

<PageLayout
  title={`${ui.taggedWith}: ${tagName} - ${ui.page} ${currentPage}`}
  description={`${ui.taggedWith} ${tagName} - ${ui.page} ${currentPage}`}
  showSidebar={true}
  i18nConfig={i18nConfig}
>
  <!-- é¢åŒ…å±‘å¯¼èˆª -->
  <nav class="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400 mb-8">
    <a href={`${localePrefix}/`} class="hover:text-primary-500 transition-colors">{ui.home}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <a href={`${localePrefix}/tags`} class="hover:text-primary-500 transition-colors">{ui.allTags}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <a href={`${localePrefix}/tags/${tagSlug}`} class="hover:text-primary-500 transition-colors">{tagName}</a>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
    <span class="text-slate-900 dark:text-slate-100">{ui.page} {currentPage}</span>
  </nav>

  <!-- é¡µé¢å¤´éƒ¨ -->
  <div class="text-center mb-12">
    <div class="inline-flex items-center justify-center w-16 h-16 bg-primary-100 dark:bg-primary-900/30 rounded-full mb-4">
      <svg class="w-8 h-8 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
      </svg>
    </div>

    <h1 class="text-4xl font-bold text-slate-900 dark:text-slate-100 mb-4">
      {tagName}
    </h1>

    <p class="text-xl text-slate-600 dark:text-slate-400 mb-8">
      {totalPosts} {ui.posts}
    </p>

    <!-- æ ‡ç­¾ç»Ÿè®¡ -->
    <div class="inline-flex items-center space-x-6 text-sm text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 px-6 py-3 rounded-lg">
      <span>#{tagName}</span>
      <span>â€¢</span>
      <span>{totalPosts} {ui.posts}</span>
      <span>â€¢</span>
      <span>{ui.page} {currentPage} / {totalPages}</span>
    </div>
  </div>

  <!-- æ–‡ç« åˆ—è¡¨ -->
  {posts.length > 0 ? (
    <div class="space-y-8 mb-12">
      {posts.map((post) => (
        <PostCard
          post={{
            slug: post.id.toLowerCase(),
            title: post.data.title,
            description: post.data.description,
            pubDate: post.data.pubDate,
            tags: post.data.tags,
            categories: post.data.categories,
            author: post.data.author,
            image: post.data.image
          }}
          layout="horizontal"
          localePrefix={localePrefix}
          locale={localeConfig.locale.dateLocale}
          ui={ui}
        />
      ))}
    </div>
  ) : (
    <div class="text-center py-16">
      <div class="text-6xl mb-4">ğŸ“</div>
      <h3 class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-2">
        {ui.noPostsFound}
      </h3>
      <p class="text-slate-600 dark:text-slate-400 mb-6">
        {ui.noPostsFound}
      </p>
      <a href={`${localePrefix}/tags`} class="btn-secondary">
        {ui.allTags}
      </a>
    </div>
  )}

  <!-- åˆ†é¡µå¯¼èˆª -->
  {totalPages > 1 && (
    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      baseUrl={`${localePrefix}/tags/${tagSlug}`}
    />
  )}

  <!-- ç›¸å…³æ ‡ç­¾ -->
  {relatedTags.length > 0 && (
    <section class="mt-16 pt-8 border-t border-slate-200 dark:border-slate-700">
      <h2 class="text-2xl font-bold text-slate-900 dark:text-slate-100 mb-6">
        {ui.popularTags}
      </h2>
      <div class="flex flex-wrap gap-3">
        {relatedTags.map((relatedTag) => (
          <a
            href={`${localePrefix}/tags/${relatedTag.slug}`}
            class="inline-flex items-center px-4 py-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg hover:border-primary-300 dark:hover:border-primary-600 hover:shadow-md transition-all duration-200 group"
          >
            <span class="font-medium text-slate-900 dark:text-slate-100 group-hover:text-primary-500 transition-colors">
              {relatedTag.name}
            </span>
            <span class="ml-2 text-xs px-2 py-1 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 rounded-full">
              {relatedTag.count}
            </span>
          </a>
        ))}
      </div>
    </section>
  )}
</PageLayout>
