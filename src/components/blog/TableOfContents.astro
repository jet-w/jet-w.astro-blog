---
export interface Props {
  headings: Array<{
    level: number;
    text: string;
    id: string;
  }>;
}

const { headings } = Astro.props;
---

{headings.length > 0 && (
  <nav class="sticky top-20 p-6" aria-label="目录">
    <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-4 border-b border-slate-200 dark:border-slate-700 pb-2">
      目录
    </h3>

    <ol class="space-y-2 text-sm">
      {headings.map((heading) => (
        <li
          class={`${
            heading.level === 2 ? 'pl-0' :
            heading.level === 3 ? 'pl-4' :
            'pl-8'
          }`}
        >
          <a
            href={`#${heading.id}`}
            class="block py-1 text-slate-600 dark:text-slate-400 hover:text-primary-500 transition-colors toc-link"
            data-heading-id={heading.id}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ol>

    <!-- 进度指示器 -->
    <div class="mt-8 pt-4 border-t border-slate-200 dark:border-slate-700">
      <div class="text-xs text-slate-500 dark:text-slate-400 mb-2">阅读进度</div>
      <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
        <div class="bg-primary-500 h-2 rounded-full transition-all duration-300" id="reading-progress" style="width: 0%"></div>
      </div>
    </div>
  </nav>
)}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('h2, h3, h4');
    const progressBar = document.getElementById('reading-progress');

    // 更新目录高亮
    function updateTocHighlight() {
      let current = '';

      headings.forEach((heading) => {
        const rect = heading.getBoundingClientRect();
        if (rect.top <= 100) {
          current = heading.id;
        }
      });

      tocLinks.forEach((link) => {
        const linkId = link.getAttribute('data-heading-id');
        if (linkId === current) {
          link.classList.add('text-primary-500', 'font-medium');
          link.classList.remove('text-slate-600', 'dark:text-slate-400');
        } else {
          link.classList.remove('text-primary-500', 'font-medium');
          link.classList.add('text-slate-600', 'dark:text-slate-400');
        }
      });
    }

    // 更新阅读进度
    function updateReadingProgress() {
      if (!progressBar) return;

      const article = document.querySelector('main');
      if (!article) return;

      const articleTop = article.offsetTop;
      const articleHeight = article.offsetHeight;
      const windowTop = window.pageYOffset;
      const windowHeight = window.innerHeight;

      const progress = Math.min(
        Math.max((windowTop - articleTop + windowHeight / 2) / articleHeight, 0),
        1
      );

      progressBar.style.width = `${progress * 100}%`;
    }

    // 平滑滚动到标题
    tocLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('data-heading-id');
        const targetElement = targetId ? document.getElementById(targetId) : null;

        if (targetElement) {
          const offsetTop = targetElement.offsetTop - 80; // 考虑固定头部的高度
          window.scrollTo({
            top: offsetTop,
            behavior: 'smooth'
          });
        }
      });
    });

    // 监听滚动事件
    let ticking = false;

    function handleScroll() {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateTocHighlight();
          updateReadingProgress();
          ticking = false;
        });
        ticking = true;
      }
    }

    window.addEventListener('scroll', handleScroll);

    // 初始化
    updateTocHighlight();
    updateReadingProgress();
  });
</script>

<style>
  .toc-link {
    position: relative;
  }

  .toc-link.text-primary-500::before {
    content: '';
    position: absolute;
    left: -12px;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 16px;
    background-color: theme('colors.primary.500');
    border-radius: 2px;
  }
</style>